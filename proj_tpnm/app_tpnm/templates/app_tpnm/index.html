<html>

<head>
    <meta charset='utf-8' />
    <title>Toponymia</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://vuejs.org/js/vue.js"></script>
    {% load static %}
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #content-wrapper {
            display: flex;
            flex-direction: row;
            flex-shrink: 1;
            height: 100%;
            transition: 400ms;
        }

        #header {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            height: 80px;
            background-color: #ffffff;
            z-index: 100;
            border-bottom: 3px solid #5d5d5d;
            background-image: url("{% static "app_tpnm/worldmap.png" %}");
        }

        #header-logo {
            height: 60%;
            margin: 20px;
            margin-right: auto;
            margin-left: 3rem;
        }

        .header-btn {
            padding: 10px;
            /* margin-left: 10px; */
            margin-right: 15px;
            color: black;
            text-decoration: none;
            font-size: 17px;
            font-family: sans-serif;
            background-color: #ffffff65
        }

        .header-btn:hover {
            background-color: #75cff075
        }

        /* #content-wrapper {
            border-top: 2px solid black;
        } */

        #map {
            position: fixed;
            top: 80px;
            bottom: 0;
            height: 100%;
            width: 100%;
            z-index: 0;
            background-color: lightblue;
        }

        #map canvas {
            cursor: default;
            z-index: 0
        }

        .mapboxcanvas-container {
            top: 20%;
        }

        .mapboxcanvas-container>svg> {
            top: 20%;
        }

        .mapboxgl-marker:hover {
            cursor: pointer;
        }

        #features {
            /* visibility: hidden; */
            position: absolute;
            top: 12%;
            right: 0;
            bottom: 0;
            width: 300px;
            overflow: auto;
            background: #ffffff95;
        }

        #sidebar {
            display: flex;
            flex-direction: column;
            flex-shrink: 1;
            text-align: center;
            justify-content: space-between;
            transition: 400ms;
            background-color: white;
            z-index: 10;
            width: 0%;
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid gray;
        }

        #sidebar-wrapper {}

        #sidebar h1 {
            margin-top: 0;
        }

        /* #sidebar #closebtn {
            position: relative;
            float: right;
            top: 20px;
            right: 20px;
            font-size: 36px;
            height: 36px;
            margin-left: 50px;
            color: #000;
            z-index: 200;
            text-decoration: none;
        }
 */
        #sidebar1 {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        #sidebar2 {
            /* display: flex;
            flex-direction: row; */
            flex-shrink: 1;
            justify-content: center;
            min-width: 60%;
            word-break: break-all;

        }

        #sidebar3 {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        #sidebar4 {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        #sidebar5 {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        #sidebar6 {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
        }

        #marker-toggle {
            position: fixed;
            text-align: center;
            height: 30px;
            width: 100px;
            top: 100px;
            left: 20px;
            background-color: #ffffff;
            z-index: 1
        }

        #marker-toggle:hover {
            background-color: #eedf9c;
        }

        /* if you get to using red/custom colors:  */
        /* .marker-red {
            background-image: url(red_pin.png);
            background-size: cover;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            cursor: pointer;
        } */

        #username {
            left: 5px;
        }

        #datetime {
            text-align: right;
        }

        #tabbar {
            display: flex;
            flex-direction: row;
            word-wrap: normal;
        }

        .tablink {
            background-color: #555;
            color: white;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            font-size: 17px;
            width: 20%;
            font-family: sans-serif;
            flex-shrink: 1
        }

        .tablink:hover {
            background-color: #777;
        }

        #Home {
            background-color: white;
        }

        #News {
            background-color: green;
        }

        #Contact {
            background-color: blue;
        }

        #About {
            background-color: orange;
        }

            {
            % block style %
        }

            {
            % endblock %
        }
    </style>
</head>

<body>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.0.0/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.0.0/mapbox-gl-geocoder.css' type='text/css' />
    <div id="page-wrapper">
        <div id="header">
            <img src="{% static "app_tpnm/tpnmlogo1.png" %}" id="header-logo" alt="Toponymia">
            <a href="#" class="header-btn">Language</a>
            <a href="#" class="header-btn">Random</a>
            <a href="#" class="header-btn">About</a>
            <a href="#" class="header-btn">Login</a>
        </div>
        <div id='content-wrapper'>
            <div id="sidebar">
                <!-- <div>
                    <a href="javascript:void(0)" id="closebtn" onclick="closeSidebar()">&times;</a>
                </div> -->
                <div class="tabbar">
                    <button class="tablink" id="defaultOpen">Article</button>
                    <button class="tablink" id="talk-tab">Talk</button>
                    <button class="tablink" id="edit-tab">Edit</button>
                    <button class="tablink" id="history-tab">History</button>
                    <button class="tablink" id="close-btn">Close</button>
                </div>
                <div id="article">
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
            <div id='map'>
                <button id="marker-toggle" type="button" name="marker-toggle">Add Marker</button>
            </div>
            <pre id='features'></pre>
        </div>
    </div>
    <script>
        var app = new Vue({
            el: '#sidebar',
            delimiters: ['[[', ']]'],
            data: {
                title: 'Title',
                content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
                username: 'username',
                datetime: 'datetime'
            }
        })
        // this is mapbox's demo key
        mapboxgl.accessToken = 'pk.eyJ1IjoieWF4eDByIiwiYSI6ImNqdW9rYXd1ODBjbjg0NHA3emp4ZDZiZWgifQ.0KqNiYI2LlrzR1lNSFJ6IA';
        // mapboxgl.accessToken = {
        //     {
        //         MAP_KEY
        //     }
        // }
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [2, 20],
            zoom: 1.5
        });
        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
        }));
        map.addControl(new mapboxgl.NavigationControl());

        function openSidebar() {
            windowWidth = window.outerWidth;
            document.getElementById("sidebar").style.width = "800px";
            document.getElementById("sidebar").style.maxWidth = "windowWidth";
            document.getElementById("map").style.marginLeft = "20%";
        }

        function closeSidebar() {
            document.getElementById("sidebar").style.width = "0";
            document.getElementById("map").style.marginLeft = "0";
        }
        document.getElementById("close-btn").onclick = closeSidebar;

        function markerToggleOn() {
            markerToggle.innerHTML = 'Cancel';
            markerToggle.style.borderStyle = 'inset';
            markerToggle.style.backgroundColor = '#f99a89';
            addMarkerMode = true;
            return addMarkerMode;
        }

        function markerToggleOff() {

            markerToggle.innerHTML = 'Add Marker';
            markerToggle.style.borderStyle = 'outset';
            markerToggle.style.backgroundColor = 'lightgray';
            addMarkerMode = false;
            return addMarkerMode;
        }
        var markerToggle = document.getElementById("marker-toggle");
        var addMarkerMode = false;
        markerToggle.addEventListener('click', function() {
            if (markerToggle.innerHTML == 'Add Marker') {
                markerToggleOn()
            } else {
                markerToggleOff()
            }
        });
        var markerHeight = 50,
            markerRadius = 10,
            linearOffset = 25; // after this was commented
        map.on('click', function(e) {
            var features = map.queryRenderedFeatures(e.point);
            document.getElementById('features').innerHTML = JSON.stringify(features, null, 2);
            var jsonfeatures = map.queryRenderedFeatures(e.point);
            // var jsonfeatures = JSON.stringify(features, null, 2);
            console.log(jsonfeatures[0]["geometry"]["type"])
        });
        map.on('click', function(e) {
            if (addMarkerMode == true) {
                var marker = new mapboxgl.Marker()
                var jsonfeatures = map.queryRenderedFeatures(e.point);
                var popup = new mapboxgl.Popup({
                        offset: 25,
                closeButton: false,
                    })
                    .setText('test');
                longLat = (jsonfeatures[0]["geometry"]["coordinates"])
                nameEn = (jsonfeatures[0]["properties"]["name_en"])
                name = (jsonfeatures[0]["properties"]["name"])
                if (typeof nameEn != "undefined" && nameEn) {
                    console.log(nameEn)
                    openSidebar()
                    // } else if (typeof name != "undefined" && name) {
                    // sidebarIframe.setAttribute("src","http://159.69.145.236/index.php/"+name)
                    // openSidebar()
                } else {
                    closeSidebar()
                }
                console.log(longLat)
                // if (longLat.length == 2) {
                if (jsonfeatures[0]["geometry"]["type"] == "Point") {
                    marker.setLngLat(longLat)
                        .setPopup(popup)
                    marker.addTo(map);
                    map.flyTo({
                        center: longLat
                    });
                    markerToggleOff();
                    // openSidebar()
                } else if (jsonfeatures[0]["geometry"]["type"] == "LineString") {
                    marker.setLngLat(longLat[Math.floor((longLat.length) / 2)])
                    marker.addTo(map);
                    map.flyTo({
                        center: longLat[Math.floor((longLat.length) / 2)]
                    });
                    markerToggleOff();
                    // openSidebar()
                } else if (jsonfeatures[0]["geometry"]["type"] == "MultiLineString") {
                    marker.setLngLat(longLat[Math.floor((longLat.length) / 2)])
                    marker.addTo(map);
                    markerToggleOff();
                    // openSidebar()
                }
            }
        });

        // var geojson_markers = {
        //     type: 'FeatureCollection',
        //     features: [{%
        //             for i in marker_locations %
        //         } {
        //             type: 'Feature',
        //             geometry: {
        //                 type: 'Point',
        //                 coordinates: [{
        //                         {
        //                             i.coord_h
        //                         }
        //                     },
        //                     {
        //                         {
        //                             i.coord_v
        //                         }
        //                     }
        //                 ]
        //             },
        //             properties: {
        //                 title: '{{ i.name }}',
        //                 description: '{{ i.status }}'
        //             }
        //         },
        //         {
        //             %
        //             endfor %
        //         }
        //     ]
        // };
        //
        // // add markers to map
        // geojson_markers.features.forEach(function(marker) {
        //
        //     // create a HTML element for each feature
        //     var el = document.createElement('div');
        //     el.className = 'marker-light-red';
        //
        //     new mapboxgl.Marker(el)
        //         .setLngLat(marker.geometry.coordinates)
        //         .setPopup(new mapboxgl.Popup({
        //                 offset: 25
        //             }) // add popups
        //             .setHTML('<h3>' + marker.properties.title + '</h3><p>' + marker.properties.description + '</p>'))
        //         .addTo(map);
        // });
        //
        //for popups
        // map.on('load', function() {
        //
        //     // Create a popup, but don't add it to the map yet.
        //     var popup = new mapboxgl.Popup({
        //         closeButton: false,
        //         closeOnClick: false
        //     });
        //
        //     function showPopup(e) {
        //         // Updates the cursor to a hand (interactivity)
        //         map.getCanvas().style.cursor = 'pointer';
        //
        //         // Show the popup at the coordinates with some data
        //         popup.setLngLat(e.features[0].geometry.coordinates)
        //             .setHTML(checkEmpty(e.features[0].properties.name))
        //             .addTo(map);
        //     }
        //
        //     function hidePopup() {
        //         map.getCanvas().style.cursor = '';
        //         popup.remove();
        //     }
        //
        //     function checkEmpty(info) {
        //         return (info) ? info : "No data";
        //     }
        //
        //     // CHANGE: Add layer names that need to be interactive
        //
        //     map.on('mouseenter', 'hospitals', showPopup);
        //     map.on('mouseleave', 'hospitals', hidePopup);
        //
        //     map.on('mouseenter', 'clinics', showPopup);
        //     map.on('mouseleave', 'clinics', hidePopup);
        // });
    </script>

</body>

</html>
